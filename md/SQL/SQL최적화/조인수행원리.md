# 조인 수행 원리

---

- 조인이란 두 개 이상의 테이블을 하나의 집합으로 만드는 연산
- 여러개 테이블이 존재하더라도 동시에 조인이 수행되는 것은 아님
- 세 개의 테이블 존재 시 먼저 두 개의 테이블에 대해 조인이 수행되고 먼저 수행된 조인 결과와 나머지 테이블 사이에서 조인이 수행
- 조인 단계별로 다른 조인 기법을 사용할 수 있다.

## NL Join
- 프로그래밍에서 사용하는 중첩된 반복문과 유사한 방식으로 조인을 수행
- 반복문 외부에 있는 테이블을 선행 테이블 또는 외부 테이블(Outer Table)이라고 함
- 내부에 있는 테이블을 후행 테이블 또는 내부 테이블(Inner Table)이라고 함

FOR 선행테이블 읽음 -> 외부 테이블(Outer Table) FOR 후행 테이블 읽음 -> 내부 테이블(Inner Table) (선행 테이블과 후행 테이블 조인)

- 결과 행의 수가 적은(처리 주관 범위가 좁은) 테이블을 조인 순서상 선행 테이블로 선택하는 것이 전체 일량을 줄일 수 있음
- **랜덤 방식으로 데이터를 액세스 하기 때문에 처리 범위가 좁은 것이 유리**

### NL Join 작업 방법
1. 선행 테이블에서 주어진 조건을 만족하는 행을 찾음
2. 선행 테이블의 조인 키 값을 가지고 후행 테이블에서 조인 수행
3. 선행 테이블의 조건을 만족하는 모든 행에 대해 1번 작업 반복 수행

> - NL Join기법은 조인이 성공하면 바로 조인 결과를 사용자에게 보여 줄 수 있다.
> - 결과를 가능한 빨리 화면에 보여줘야 하는 온라인 프로그램에 적당한 조인 기법

## Sort Merge Join
- 조인 칼럼을 기준으로 데이터를 정렬하여 조인을 수행
- 주로 스캔 방식으로 데이터를 읽음
- Sort Merge Join은 랜덤 액세스로 NL Join에서 부담이 되던 넓은 범위의 데이터를 처리할 때 이용되던 처리 기법
- 정렬할 데이터가 많아 메모리에서 모든 정렬 작업을 수행하기 어려운 경우에는 임시 영역(디스크)을 사용하기 때문에 성능이 떨어질 수 있음
- **일반적으로 대량의 조인 작업에서 정렬 작업을 필요로 하는 Sort Merge Join 보다는 CPU 작업 위주로 처리하는 Hash Join이 성능상 유리**
- **Hash Join과는 달리 동등 조인 뿐 아니라 비동등 조인에 대해서도 조인 작업이 가능하다는 장점이 있음**

### Sort Merge Join 작업 방법
1. 선행 테이블에서 주어진 조건을 만족하는 행을 찾음
2. 선행 테이블의 조인 키를 기준으로 정렬 작업을 수행 1 ~ 2 번 작업을 선행 테이블의 조건을 만족하는 모든 행에 대해 반복 수행
3. 후행 테이블에서 주어진 조건을 만족하는 행을 찾음
4. 후행 테이블의 조인 키를 기준으로 정렬 작업을 수행 3 ~ 4 번 작업을 후행 테이블의 조건을 만족하는 모든 행에 대해 반복 수행
5. 정렬된 결과를 이용하여 조인을 수행하며 조인에 성공하면 추출버퍼에 넣음

> - 조인 칼럼의 인덱스를 사용하지 않기 때문에 조인 칼럼의 인덱스가 존재하지 않을 경우에도 사용할 수 있는 조인 기법
> - 조인할 테이블 중에서 이미 앞 단계의 작업을 수행하는 도중 정렬 작업이 미리 수행되었따면 조인을 위한 정렬 작업은 발생하지 않을 수 있다.

## Hash Join
- 해싱 기법을 이용해 조인을 수행
- 조인을 수행할 테이블의 조인 칼럼을 기준으로 해쉬 함수를 수행하여 서로 동일한 해쉬 값을 갖는 것들 사이에서 실제 값이 같은지를 비교하면서 조인을 수행
- NL Join의 랜덤 액세스 문제점과 Sort Merge Join의 문제점인 정렬 작업의 부담을 해결하기 위한 대안으로 등장

### 동작
1. 선행 테이블에서 주어진 조건을 만족하는 행을 찾음
2. 선행 테이블의 조인 키를 기준으로 해쉬 함수를 적용하여 해쉬 테이블을 생성 -> 조인 칼럼과 SELECT 절에서 필요로 하는 칼럼도 함께 저장 됨 1 ~ 2번 작업을 선행 테이블의 조건을 만족하는 모든 행에 대해 반복 수행
3. 후행 테이블에서 주어진 조건을 만족하는 행을 찾음
4. 후행 테이블의 조인 키를 기준으로 해쉬 함수를 적용하여 해당 버킷을 찾음 -> 조인 키를 이용해서 실제 조인될 데이터를 찾음
5. 조인에 성공하면 추출버퍼에 넣음 3 ~ 5번 작업을 후행 테이블의 조건을 만족하는 모든 행에 대해서 반복 수행

> - 조인 칼럼의 인덱스를 사용하지 않기 때문에 조인 칼럼의 인덱스가 존재하지 않을 경우에도 사용할 수 있는 조인 기법
> - 해쉬 함수를 이용하여 조인을 수해앟기 때문에 '='로 수행하는 조인 즉, 동등 조인에서만 사용할 수 있다.
> - 해쉬 함수가 적용될 때 동일한 값은 항상 같은 값으로 해싱됨이 보장 됨(큰 값이 항상 큰값, 작은 값이 항상 작은 값으로 해싱된다는 보장 없음 그렇기 때문에 동등 조인에서만 사용)
> - 결과 행의 수가 적은 테이블을 선행 테이블로 사용하는 것이 좋음(선행 테이블의 결과를 완전히 메모리에 저장할 수 있다면 임시 영역에 저장하는 작업이 발생하지 않음)
> - 

